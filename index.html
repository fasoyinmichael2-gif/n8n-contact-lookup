<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Contact Lookup & Save</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Inter font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; }

        /* Custom styles for animations and specific visual flair, keeping the joke generator's aesthetic */
        .panel-bg {
            /* Mimics the colorful background of the original panel */
            background: rgba(255, 255, 255, 0.95);
            position: relative;
            overflow: hidden;
        }
        .panel-bg::before {
            content: '';
            position: absolute;
            top: -2px; left: -2px; right: -2px; bottom: -2px;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4, #feca57);
            border-radius: 1.625rem; /* slightly larger than rounded-3xl */
            z-index: -1;
            animation: rainbow 3s linear infinite;
        }

        @keyframes rainbow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .loading {
            display: inline-block;
            width: 1.25rem;
            height: 1.25rem;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 md:p-10 flex flex-col items-center bg-gradient-to-br from-indigo-500 to-purple-700 text-gray-800">

    <!-- Header / Logo -->
    <div class="text-center mb-8">
        <!-- Using a placeholder for the SEMKHOR logo -->
        <h1 class="text-4xl font-extrabold text-white drop-shadow-lg">SEMKHOR</h1>
        <p class="text-indigo-200 mt-1">AI Contact & Data Lookup</p>
    </div>

    <!-- Main Input Panel -->
    <div id="contactInput" class="panel-bg p-6 md:p-8 w-full max-w-xl rounded-3xl shadow-2xl transition duration-500 hover:shadow-indigo-500/50">
        <p class="text-lg font-semibold text-center text-indigo-700 mb-4">
            Find contact information for...
        </p>
        <input type="text" id="contact_query" placeholder="procurement manager of the Bokku! Mart in East Lagos" class="w-full p-4 border-2 border-indigo-500 rounded-xl text-lg mb-6 focus:border-cyan-500 focus:ring-0 transition duration-300">
        <button id="submitBtn" onclick="submitPrompt()" class="w-full py-4 text-xl font-bold text-white rounded-xl shadow-lg transition duration-300 ease-in-out bg-gradient-to-r from-red-500 to-pink-500 hover:from-red-600 hover:to-pink-600 hover:shadow-xl">
            Look Up Contact!
        </button>
    </div>
    
    <!-- Status Message Area -->
    <div id="status" class="status-message w-full max-w-xl my-4 text-center font-medium p-3 rounded-lg hidden"></div>

    <!-- Review Panel (Hidden by default) -->
    <div id="contactReview" class="panel-bg p-6 md:p-8 w-full max-w-xl rounded-3xl shadow-2xl mt-8 transition duration-500" style="display:none;">
        <h2 class="text-2xl font-bold text-center text-indigo-700 mb-4">Review Contact Information</h2>
        <p class="text-center text-gray-600 mb-4">Would you like to save this result to your history?</p>
        <div id="contact_content" class="bg-indigo-50 border-l-4 border-indigo-500 rounded-lg p-4 md:p-6 text-base md:text-lg whitespace-pre-wrap min-h-20 flex items-center justify-center text-gray-700 shadow-inner">
            <!-- Contact info will be displayed here -->
        </div>
        <div class="flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-4 mt-6">
            <button class="button_yes w-full sm:w-1/2 py-3 text-lg font-bold text-white rounded-xl transition duration-300 ease-in-out bg-gradient-to-r from-teal-500 to-cyan-600 hover:from-teal-600 hover:to-cyan-700 shadow-md" onclick="respond(true)">
                Yes, Save to History!
            </button>
            <button class="button_no w-full sm:w-1/2 py-3 text-lg font-bold text-white rounded-xl transition duration-300 ease-in-out bg-gradient-to-r from-pink-500 to-red-600 hover:from-pink-600 hover:to-red-700 shadow-md" onclick="respond(false)">
                No, Discard
            </button>
        </div>
    </div>

    <!-- Previously Saved Contacts Section -->
    <div id="historySection" class="bg-white p-6 md:p-8 w-full max-w-xl rounded-2xl shadow-xl mt-8 transition duration-500">
        <h2 class="text-2xl font-bold text-indigo-700 mb-4 border-b pb-2">Your Saved Contacts (History)</h2>
        <div id="history_list" class="space-y-4">
            <p id="history_loading" class="text-gray-500">Loading history...</p>
            <p id="history_empty" class="text-gray-500 hidden">No contacts saved yet.</p>
            <!-- History items will be loaded here -->
        </div>
    </div>
    
    <!-- FIREBASE AND APP LOGIC -->
    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, query, orderBy, doc, setDoc, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ====================================================================
        // CONFIGURATION (PLEASE UPDATE THESE PLACEHOLDERS)
        // ====================================================================
        
        // This is the full URL of your N8N Webhook Trigger node.
        // E.g., 'https://your-workspace.app.n8n.cloud/webhook/a1b2c3d4-e5f6-7890-a1b2-c3d4e5f67890'
        const N8N_WEBHOOK_URL = "https://your-n8n-domain.app.n8n.cloud/webhook/YOUR_WEBHOOK_ID";
        
        // This is the domain of your N8N workspace for the polling API call.
        // E.g., 'https://alexsemkhor.app.n8n.cloud'
        const N8N_WORKFLOW_DOMAIN = "https://your-n8n-domain.app.n8n.cloud";

        // The name of the node where the contact data is returned in your N8N execution output.
        // This path must match the JSON output field name you configured in the 'n8n-poll' tool.
        // For the joke app, this was "Message a model". We assume your LLM node is the same.
        const LLM_NODE_NAME = "Message a model";

        // ====================================================================
        // GLOBAL VARIABLES & FIREBASE SETUP
        // ====================================================================
        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;

        // Global variables for N8N execution data
        let executionId = null;
        let executionResumeUrl = null;
        let currentContactResult = null;
        
        // Firestore path helpers
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-contact-lookup-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // SEMKHOR API constants (copied from joke app source)
        const API_CLIENT_CODE = window.location.hostname === "www.semkhor.com" ? "semkhorproductions1" : "abctooldyeco";
        const API_URL = window.location.hostname === "www.semkhor.com" ? "https://www.semkhor.com/api/" : "https://site01.semlab.net/api/";

        function initFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Set Firestore log level to debug for better diagnostics
                setLogLevel('debug');

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        loadHistory();
                    } else {
                        // Sign in anonymously if no token is provided, or if sign-in failed
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    }
                });

            } catch (e) {
                console.error("Firebase initialization failed:", e);
                // Fallback to anonymous ID if Firebase fails
                userId = crypto.randomUUID();
                isAuthReady = true;
                // Note: We don't call showStatus here to avoid potential race conditions before the DOM is fully loaded.
                const historyLoading = document.getElementById('history_loading');
                if (historyLoading) {
                    historyLoading.textContent = 'Error loading history: Firebase failed to initialize.';
                }
            }
        }

        /**
         * Loads and displays the user's previously saved contacts from Firestore in real-time.
         */
        function loadHistory() {
            if (!isAuthReady || !db) return;
            
            const historyRef = collection(db, `artifacts/${appId}/users/${userId}/contact_lookups`);
            const q = query(historyRef);

            // Use onSnapshot for real-time updates
            onSnapshot(q, (snapshot) => {
                const historyList = document.getElementById('history_list');
                const historyEmpty = document.getElementById('history_empty');
                const historyLoading = document.getElementById('history_loading');
                
                // Clear the list first
                historyList.innerHTML = '';

                const contacts = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                })).sort((a, b) => b.timestamp?.seconds - a.timestamp?.seconds); // Sort by newest first

                if (contacts.length === 0) {
                    if (historyEmpty) historyEmpty.classList.remove('hidden');
                    if (historyLoading) historyLoading.classList.add('hidden');
                    return;
                }

                if (historyEmpty) historyEmpty.classList.add('hidden');
                if (historyLoading) historyLoading.classList.add('hidden');
                
                contacts.forEach(contact => {
                    const item = document.createElement('div');
                    item.className = 'bg-gray-50 p-4 border border-gray-200 rounded-lg shadow-sm hover:bg-gray-100 transition duration-150';
                    
                    const timestamp = contact.timestamp?.toDate ? contact.timestamp.toDate().toLocaleString() : 'N/A';
                    
                    item.innerHTML = `
                        <p class="font-bold text-indigo-600 mb-1">${contact.query || 'Untitled Query'}</p>
                        <pre class="text-sm bg-white p-2 border rounded-md text-gray-700 whitespace-pre-wrap">${contact.result || 'No contact found.'}</pre>
                        <p class="text-xs text-gray-400 mt-2">Saved: ${timestamp}</p>
                    `;
                    historyList.appendChild(item);
                });
            }, (error) => {
                console.error("Error loading history:", error);
                const historyLoading = document.getElementById('history_loading');
                if (historyLoading) {
                    historyLoading.textContent = 'Error fetching history data.';
                }
            });
        }
        
        // ====================================================================
        // N8N WORKFLOW LOGIC (ADAPTED FROM JOKE APP)
        // ====================================================================

        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            
            // FIX: Check if statusDiv exists before manipulating its classList
            if (!statusDiv) {
                console.error('Status div not found, cannot show status message.');
                return;
            }

            statusDiv.classList.remove('hidden', 'status-success', 'status-error', 'status-info');
            
            let bgColor = 'bg-blue-100 border-blue-400 text-blue-800';
            if (type === 'success') bgColor = 'bg-green-100 border-green-400 text-green-800';
            if (type === 'error') bgColor = 'bg-red-100 border-red-400 text-red-800';
            
            statusDiv.className = `status-message w-full max-w-xl my-4 text-center font-medium p-3 rounded-lg border-2 ${bgColor}`;
            statusDiv.innerHTML = message;
        }

        function showLoading(element, text = 'Processing...') {
            element.innerHTML = `<span class="loading mr-2"></span>${text}`;
            element.disabled = true;
            element.classList.add('opacity-50', 'cursor-not-allowed');
        }

        function hideLoading(element, originalText) {
            element.innerHTML = originalText;
            element.disabled = false;
            element.classList.remove('opacity-50', 'cursor-not-allowed');
        }
        
        function formatContactText(text) {
            if (!text) return 'No contact information was returned by the AI.';
            // Clean up and format the text, replacing common JSON escapes
            return text
                .replace(/\\n/g, '\n')
                .replace(/\\r/g, '')
                .replace(/\\t/g, '    ')
                .replace(/\\"/g, '"')
                .replace(/\\'/g, "'")
                .trim();
        }

        window.submitPrompt = async function() {
            const contactQuery = document.getElementById("contact_query").value.trim();
            if (!contactQuery) {
                showStatus('Please enter a query for the contact search!', 'error');
                return;
            }

            // The full prompt sent to the LLM node
            const prompt = `Find the contact information (email, phone, other relevant details) for: "${contactQuery}". Respond only with the contact information in a clear, formatted text block.`;
            const submitBtn = document.getElementById("submitBtn");
            const originalText = submitBtn.innerHTML;
            
            submitBtn.disabled = true;
            document.getElementById("contact_query").disabled = true;
            
            showLoading(submitBtn, 'Searching...');
            showStatus('Starting contact lookup workflow...', 'info');
            document.getElementById('contact_content').innerHTML = '<p class="text-lg text-indigo-500 animate-pulse">ðŸ¤– AI is searching for contacts, please wait...</p>';

            try {
                // 1. Trigger Workflow via semkhor/api/util/json-proxy
                const response = await fetch(API_URL + 'util/json-proxy', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'SEMKHOR-CLIENT-CODE': API_CLIENT_CODE
                    },
                    body: JSON.stringify({
                        url: N8N_WEBHOOK_URL, // Use the new constant
                        method: 'POST',
                        headers: [{"name": "token", "value": "{auth:n8n_header}"}],
                        data: {"prompt": prompt, "query_text": contactQuery} // Send both full prompt and raw query
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                
                executionId = data.response.executionId;
                executionResumeUrl = data.response.executionResumeUrl;

                if (!executionId || !executionResumeUrl) {
                    throw new Error('Missing execution data from workflow response. Check N8N webhook configuration.');
                }

                showStatus('AI is working on your query...', 'info');
                
                // Chain to workflowWait
                await workflowWait(contactQuery);

            } catch (error) {
                console.error('Error submitting prompt:', error);
                showStatus(`Error: ${error.message}. Please check console for details.`, 'error');
                // Re-enable controls on error
                submitBtn.disabled = false;
                document.getElementById("contact_query").disabled = false;
                document.getElementById('contact_content').innerHTML = '';
                hideLoading(submitBtn, originalText);
            }
        }

        async function workflowWait(query) {
            const maxCycles = 5; 
            let currentCycle = 1;

            const pollCycle = async () => {
                try {
                    showStatus(`Waiting for AI result... (cycle ${currentCycle}/${maxCycles})`, 'info');
                    
                    // 2. Poll the n8n execution status (semkhor endpoint waits ~40 seconds internally)
                    const pollUrl = `${N8N_WORKFLOW_DOMAIN}/api/v1/executions/${executionId}`;
                    const response = await fetch(API_URL + 'ai/n8n-poll', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'SEMKHOR-CLIENT-CODE': API_CLIENT_CODE
                        },
                        body: JSON.stringify({
                            url: pollUrl,
                            headers: [{"name": "X-N8N-API-KEY", "value": "{auth:n8n_api_key}"}],
                            // We expect the LLM output to be available here
                            output_paths: [`data.resultData.runData["${LLM_NODE_NAME}"][0].data.main[0][0].json.message.content`]
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();
                    
                    // Check if we have a result and the status is 'waiting' (at the Wait node)
                    if (data.response.status === 'waiting' && data.response.value1) {
                        currentContactResult = {
                            query: query,
                            result: formatContactText(data.response.value1)
                        };
                        reviewContact(currentContactResult);
                        return;
                    }

                    // Check if the semkhor endpoint timed out
                    if (data.response.status === 'timeout') {
                        if (currentCycle < maxCycles) {
                            currentCycle++;
                            // Retry after a short delay
                            setTimeout(pollCycle, 3000); 
                        } else {
                            throw new Error('Maximum wait time exceeded. The AI did not reach the wait node in time.');
                        }
                    } else {
                        // Unexpected status, throw error
                        throw new Error(`Unexpected response status: ${data.response.status}`);
                    }

                } catch (error) {
                    console.error('Error polling workflow:', error);
                    showStatus(`Error polling: ${error.message}`, 'error');
                    // Re-enable controls on error
                    document.getElementById("submitBtn").disabled = false;
                    document.getElementById("contact_query").disabled = false;
                    document.getElementById('contact_content').innerHTML = '';
                }
            };

            // Start first polling cycle
            pollCycle();
        }

        function reviewContact(contactResult) {
            // Present the contact info to the user for review
            showStatus('Contact information found. Please review and decide whether to save.', 'success');
            
            document.getElementById('contact_content').innerHTML = 
                `<p class="font-semibold text-indigo-600 mb-2">Query:</p><p class="mb-4">${contactResult.query}</p>` +
                `<p class="font-semibold text-indigo-600 mb-2">Result:</p><pre>${contactResult.result}</pre>`;
            
            document.getElementById('contactInput').classList.add('hidden');
            document.getElementById('contactReview').style.display = 'block';
            
            // Scroll to the review section
            document.getElementById('contactReview').scrollIntoView({ behavior: 'smooth' });
        }

        window.respond = async function(answer) {
            // The key expected by your N8N Wait node to resume the workflow
            const payload = {
                saveToSheets: answer
            };

            const yesBtn = document.querySelector('#contactReview .button_yes');
            const noBtn = document.querySelector('#contactReview .button_no');
            const activeBtn = answer ? yesBtn : noBtn;
            const originalText = activeBtn.innerHTML;
            
            showLoading(activeBtn, answer ? 'Saving...' : 'Discarding...');
            
            // Disable both buttons during processing
            yesBtn.disabled = true;
            noBtn.disabled = true;
            
            try {
                // 3. Post payload to the n8n wait node to resume the workflow
                const response = await fetch(API_URL + 'util/json-proxy', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        url: executionResumeUrl, // Use the executionResumeUrl
                        method: 'POST',
                        headers: [{"name": "token", "value": "{auth:n8n_header}"}],
                        data: payload
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                // If saved, commit to Firestore as well for display in history
                if (answer) {
                    await saveToHistory(currentContactResult);
                }

                // Show final completion message
                const completionMsg = answer ? 
                    'ðŸŽ‰ Success! Contact info saved to history and workflow completed (saving to sheets in background)! ðŸš€' : 
                    'âœ… Workflow Complete! Data was discarded. ðŸ‘';
                
                const completionDiv = document.createElement('div');
                completionDiv.className = 'w-full bg-green-500 text-white p-4 rounded-xl text-lg font-bold text-center shadow-lg mt-6';
                document.getElementById('contactReview').appendChild(completionDiv);
                
                showStatus('Workflow completed successfully!', 'success');
                
                // Add a reset button
                setTimeout(() => {
                    const resetBtn = document.createElement('button');
                    resetBtn.innerHTML = 'ðŸ”„ Start New Lookup';
                    resetBtn.onclick = resetForm;
                    resetBtn.className = 'w-full mt-4 py-3 text-lg font-bold text-white rounded-xl transition duration-300 bg-indigo-500 hover:bg-indigo-600 shadow-md';
                    document.getElementById('contactReview').appendChild(resetBtn);
                }, 1500);

            } catch (error) {
                console.error('Error responding or saving:', error);
                showStatus(`Error: ${error.message}`, 'error');
                
                // Re-enable buttons on error
                yesBtn.disabled = false;
                noBtn.disabled = false;
                hideLoading(activeBtn, originalText);
            }
        }
        
        /**
         * Saves the contact result to the user's private Firestore history.
         */
        async function saveToHistory(contactResult) {
            if (!isAuthReady || !db) {
                console.warn("Cannot save to history, Firebase not ready.");
                return;
            }
            try {
                const docRef = doc(collection(db, `artifacts/${appId}/users/${userId}/contact_lookups`));
                await setDoc(docRef, {
                    query: contactResult.query,
                    result: contactResult.result,
                    timestamp: serverTimestamp()
                });
                console.log("Contact successfully saved to Firestore history.");
            } catch (e) {
                console.error("Error writing document to history:", e);
                showStatus("Error: Could not save data to history. See console.", 'error');
            }
        }

        window.resetForm = function() {
            // Reset the form for another lookup
            document.getElementById('contactInput').classList.remove('hidden');
            document.getElementById('contactReview').style.display = 'none';
            document.getElementById('contact_query').value = '';
            document.getElementById('contact_content').innerHTML = '';
            
            // Re-enable input controls and restore original button text
            document.getElementById('contact_query').disabled = false;
            const submitBtn = document.getElementById('submitBtn');
            hideLoading(submitBtn, 'Look Up Contact!');
            
            // Clear status
            const statusDiv = document.getElementById('status');
            if (statusDiv) statusDiv.classList.add('hidden'); // Added check here
            
            // Remove completion message and reset button
            const reviewDiv = document.getElementById('contactReview');
            // Remove dynamically added elements (completion message and reset button)
            Array.from(reviewDiv.children).forEach(child => {
                if (child.className.includes('w-full mt-4') || child.className.includes('w-full bg-green-500')) {
                    child.remove();
                }
            });
            
            // Reset review buttons
            const yesBtn = document.querySelector('#contactReview .button_yes');
            const noBtn = document.querySelector('#contactReview .button_no');
            hideLoading(yesBtn, 'Yes, Save to History!');
            hideLoading(noBtn, 'No, Discard');
            
            // Reset global variables
            executionId = null;
            executionResumeUrl = null;
            currentContactResult = null;
            
            // Scroll back to top
            document.getElementById('contactInput').scrollIntoView({ behavior: 'smooth' });
        }
        
        // FIX: Wrap initFirebase in a DOMContentLoaded listener to ensure all elements are available
        document.addEventListener('DOMContentLoaded', initFirebase);
        
        // Remove the direct call: initFirebase();
    </script>
</body>
</html>
