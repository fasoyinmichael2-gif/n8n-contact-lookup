<script>
    /* --- API Configuration --- */
const API_CLIENT_CODE = "semkhorproductions1"; 
const API_URL = "https://www.semkhor.com/api/"; 
    
    const N8N_BASE_URL = "https://alexsemkhor.app.n8n.cloud"; 
    
    const CONTACT_WEBHOOK_ID = "d6c04913-2e31-4a0e-ac01-f8a5341fa133";
    const SAVED_DATA_WEBHOOK_ID = "f1a1833b-d2c0-4d22-b034-77090fdd24f4"; 
    const CONTACT_OUTPUT_PATH = "data.resultData.runData[\"Contact Lookup AI\"][0].data.main[0][0].json.message.content";
    
    let executionId = null;
    let executionResumeUrl = null;
    let currentContactInfo = null;

    /* --- Utility Functions --- */
    function showStatus(message, type = 'info') { 
        const statusDiv = document.getElementById('status') || document.createElement('div');
        if (!document.getElementById('status')) {
            statusDiv.id = 'status';
            statusDiv.classList.add('status-message');
            document.getElementById('lookupInput').appendChild(statusDiv);
        }
        statusDiv.className = `status-message status-${type}`;
        statusDiv.innerHTML = message;
    }
    function showLoading(element, text = 'Processing...') { 
        element.innerHTML = `<span class="loading"></span>${text}`;
        element.disabled = true;
        element.classList.add('disabled-button');
    }
    function hideLoading(element, originalText) {
        element.innerHTML = originalText;
        element.disabled = false;
        element.classList.remove('disabled-button');
    }
    function formatText(text) { 
        return (text || '')
            .replace(/\\n/g, '<br>')
            .replace(/\\r/g, '')
            .replace(/\\t/g, '&nbsp;&nbsp;&nbsp;&nbsp;')
            .replace(/\\"/g, '"')
            .replace(/\\'/g, "'")
            .replace(/\\\\/g, '\\')
            .trim();
    }
    
    /* ------------------------------------------------------------------- */
    
    // Stage 1: Initial Prompt Submission (START WORKFLOW)
    async function submitContactPrompt() {
        const promptElement = document.getElementById("lookup_prompt");
        const lookupPrompt = promptElement.value.trim();
        const submitBtn = document.getElementById('submitBtn');
        const originalText = submitBtn.innerHTML;

        if (!lookupPrompt) {
            showStatus('Please enter a request for contact information!', 'error');
            return;
        }

        submitBtn.disabled = true;
        promptElement.disabled = true;
        showLoading(submitBtn, 'Searching AI...');
        document.getElementById('contact_content').innerHTML = '<div class="waiting-animation"></div>';
        showStatus('Starting contact lookup workflow...', 'info');

        try {
            // 1. Trigger N8N workflow via semkhor json-proxy
            const response = await fetch(API_URL+'util/json-proxy', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'SEMKHOR-CLIENT-CODE': API_CLIENT_CODE
                },
                body: JSON.stringify({
                    url: `${N8N_BASE_URL}/webhook/${CONTACT_WEBHOOK_ID}`, 
                    method: 'POST',
                    headers: [{"name": "token", "value": "{auth:n8n_header}"}], 
                    data: {"prompt": lookupPrompt}
                })
            });

            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const data = await response.json();
            
            executionId = data.response.return.executionId; 
            executionResumeUrl = data.response.return.executionResumeUrl; 

            if (!executionId || !executionResumeUrl) {
                throw new Error('Missing execution data from workflow response');
            }

            showStatus('AI is looking up contact details...', 'info');
            
            await workflowWait(submitBtn, originalText);

        } catch (error) {
            console.error('Error submitting prompt:', error);
            showStatus(`Error: ${error.message}`, 'error');
            submitBtn.disabled = false;
            promptElement.disabled = false;
            document.getElementById('contact_content').innerHTML = '';
            hideLoading(submitBtn, originalText);
        }
    }

    // Stage 2: Polling for AI result (PAUSE/POLL)
    async function workflowWait(submitBtn, originalText) {
        const maxCycles = 5; 
        let currentCycle = 1;

        const pollCycle = async () => {
            try {
                showStatus(`Polling for AI result... (cycle ${currentCycle}/${maxCycles})`, 'info');
                
                const response = await fetch(API_URL+'ai/n8n-poll', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'SEMKHOR-CLIENT-CODE': API_CLIENT_CODE
                    },
                    body: JSON.stringify({
                        url: `${N8N_BASE_URL}/api/v1/executions/${executionId}`, 
                        headers: [{"name": "X-N8N-API-KEY", "value": "{auth:n8n_api_key}"}], 
                        output_paths: [CONTACT_OUTPUT_PATH] 
                    })
                });

                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                
                if (data.response.status === 'waiting' && data.response.value1) {
                    currentContactInfo = data.response.value1;
                    hideLoading(submitBtn, originalText); 
                    reviewContactInfo(currentContactInfo);
                    return; // Stop polling
                }

                if (data.response.status === 'timeout' && currentCycle < maxCycles) {
                    currentCycle++;
                    showStatus(`AI is taking longer than usual... trying again (cycle ${currentCycle}/${maxCycles})`, 'info');
                    setTimeout(pollCycle, 4000); 
                } else if (data.response.status === 'timeout') {
                    throw new Error('Maximum wait time exceeded. The workflow might have stalled or timed out completely.');
                } else {
                    throw new Error(`Unexpected response status: ${data.response.status}`);
                }

            } catch (error) {
                console.error('Error polling workflow:', error);
                showStatus(`Error waiting for result: ${error.message}`, 'error');
                hideLoading(submitBtn, originalText);
                document.getElementById("lookup_prompt").disabled = false;
                document.getElementById('contact_content').innerHTML = '';
            }
        };

        pollCycle();
    }

    // Stage 3: Display results and ask for save decision
    function reviewContactInfo(info) {
        showStatus('Contact information found!', 'success');
        
        const formattedInfo = formatText(info);
        document.getElementById('contact_content').innerHTML = `**Request:** ${document.getElementById("lookup_prompt").value}<br><br>**AI Result:**<br>${formattedInfo}`;
        
        // Switch UI panels
        document.getElementById('lookupInput').style.display = 'none';
        document.getElementById('reviewSection').style.display = 'block';
        
        document.getElementById('reviewSection').scrollIntoView({ behavior: 'smooth' });
    }

    // Stage 4: Resume workflow with user decision (SAVE/REJECT)
    async function respondToSave(saveData) {
        // MODIFIED: Simplified payload to only send the boolean required by the If node.
        const payload = {
            saveToSheets: saveData 
        };

        const saveBtn = document.getElementById('saveBtn');
        const rejectBtn = document.getElementById('rejectBtn');
        const activeBtn = saveData ? saveBtn : rejectBtn;
        const originalText = activeBtn.innerHTML;
        
        showLoading(activeBtn, saveData ? 'Saving to Sheets...' : 'Canceling Save...');
        saveBtn.disabled = true;
        rejectBtn.disabled = true;
        saveBtn.classList.add('disabled-button');
        rejectBtn.classList.add('disabled-button');

        try {
            // Post the payload to the n8n Wait node resume URL
            const response = await fetch(API_URL+'util/json-proxy', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'SEMKHOR-CLIENT-CODE': API_CLIENT_CODE },
                body: JSON.stringify({
                    url: executionResumeUrl, 
                    method: 'POST',
                    headers: [{"name": "token", "value": "{auth:n8n_header}"}],
                    data: payload 
                })
            });

            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

            hideLoading(activeBtn, originalText);
            
            const completionMsg = saveData ?	
                '✅ Success! Contact details have been saved to Google Sheets. 💾' :	
                '❌ Decision finalized. Data was NOT saved to Google Sheets. 👍';
            
            const completionDiv = document.createElement('div');
            completionDiv.className = 'completion-message';
            completionDiv.innerHTML = completionMsg;
            document.getElementById('reviewSection').appendChild(completionDiv);
            
            showStatus('Workflow completed successfully!', 'success');
            
            // Show a reset button and the "View Saved Data" button
            setTimeout(() => {
                const resetBtn = document.createElement('button');
                resetBtn.innerHTML = '🔄 Start New Lookup';
                resetBtn.onclick = resetForm;
                resetBtn.style.marginTop = '20px';
                document.getElementById('reviewSection').appendChild(resetBtn);

                const viewBtn = document.createElement('button');
                viewBtn.innerHTML = '📂 View Saved Data';
                viewBtn.onclick = viewSavedData;
                viewBtn.classList.add('button_view');
                document.getElementById('reviewSection').appendChild(viewBtn);

            }, 1500);

        } catch (error) {
            console.error('Error responding:', error);
            showStatus(`Error resuming workflow: ${error.message}`, 'error');
            
            // Re-enable buttons on error
            saveBtn.disabled = false;
            rejectBtn.disabled = false;
            saveBtn.classList.remove('disabled-button');
            rejectBtn.classList.remove('disabled-button');
            hideLoading(activeBtn, originalText);
        }
    }

    // Feature: Display previously saved data (Simplified: Direct Link to Sheet)
    async function viewSavedData() {
        const SHEET_URL = "https://docs.google.com/spreadsheets/d/15E13ShiEYhbN4FlwFplmK38rw4lZGQCll_U99CdqBuQ/edit?gid=0#gid=0";
        
        // Open the Google Sheet URL in a new browser tab/window
        window.open(SHEET_URL, '_blank');
        
        // Optionally, display a success message temporarily on the UI
        const statusDiv = document.getElementById('status') || document.createElement('div');
        if (!document.getElementById('status')) {
            statusDiv.id = 'status';
            statusDiv.classList.add('status-message');
            document.getElementById('lookupInput').appendChild(statusDiv);
        }
        statusDiv.className = `status-message status-success`;
        statusDiv.innerHTML = '📂 Opening Google Sheet in a new tab!';

        // Hide the table panel if it was already showing
        document.getElementById('savedDataSection').style.display = 'none';
        
        // Clear the message after a few seconds
        setTimeout(() => {
            if (statusDiv) { statusDiv.remove(); }
        }, 3000);
    }

    function resetForm() {
        // Clear all state and display the initial input panel
        document.getElementById('lookupInput').style.display = 'block';
        document.getElementById('reviewSection').style.display = 'none';
        document.getElementById('savedDataSection').style.display = 'none';
        document.getElementById('lookup_prompt').value = '';
        document.getElementById('contact_content').innerHTML = '';
        
        // Re-enable input controls and restore original button text
        document.getElementById('lookup_prompt').disabled = false;
        const submitBtn = document.getElementById('submitBtn');
        submitBtn.disabled = false;
        submitBtn.innerHTML = 'Look Up Contact!';
        
        // Reset review buttons
        const saveBtn = document.getElementById('saveBtn');
        const rejectBtn = document.getElementById('rejectBtn');
        saveBtn.disabled = false;
        rejectBtn.disabled = false;
        saveBtn.classList.remove('disabled-button');
        rejectBtn.classList.remove('disabled-button');
        
        // Clear status and completion messages
        const statusDiv = document.getElementById('status');
        if (statusDiv) { statusDiv.remove(); }
        const completionDiv = document.querySelector('.completion-message');
        if (completionDiv) { completionDiv.remove(); }
        const reviewBtns = document.querySelectorAll('#reviewSection button');
        reviewBtns.forEach(btn => {
            if (btn.innerHTML.includes('Start New Lookup') || btn.innerHTML.includes('View Saved Data')) {
                btn.remove();
            }
        });
        
        // Reset global variables
        executionId = null;
        executionResumeUrl = null;
        currentContactInfo = null;
        
        document.getElementById('lookupInput').scrollIntoView({ behavior: 'smooth' });
    }
</script>
</head>
<body>

	<div class="header">
		<img src="ai-joke/images/semkhor_transparent.png" alt="SEMKHOR Logo">
	</div>

	<div class="panel" id="lookupInput">
		Find contact information for...
		<input type="text" id="lookup_prompt" placeholder="e.g., procurement manager of Bokku! Mart in East Lagos"><br>
		<button id="submitBtn" onclick="submitContactPrompt()">Look Up Contact!</button>
	</div>
	
	<div class="panel" id="reviewSection" style="display: none;">
		<h3 style="margin-bottom: 10px;">Review AI-Generated Contact Information</h3>
		<div id="contact_content"></div>
		<button id="saveBtn" class="button_save" onclick="respondToSave(true)">Save to Google Sheets</button>
		<button id="rejectBtn" class="button_reject" onclick="respondToSave(false)">Reject, Do Not Save</button>
	</div>

    <div class="panel" id="savedDataSection" style="display: none;">
		<h3 style="margin-bottom: 10px; color: #5a67d8;">Previously Saved Contact Leads</h3>
		<div id="savedDataTableContainer">
			</div>
        <button onclick="document.getElementById('savedDataSection').style.display='none'; document.getElementById('reviewSection').scrollIntoView({ behavior: 'smooth' });">Hide Table</button>
	</div>


</body>
</html>
