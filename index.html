<script>
Â  Â  /* --- API Configuration --- */
const API_CLIENT_CODE = "semkhorproductions1"; 
const API_URL = "https://www.semkhor.com/api/"; 
Â  Â Â 
Â  Â  const N8N_BASE_URL = "https://alexsemkhor.app.n8n.cloud";Â 
Â  Â Â 
Â  Â  const CONTACT_WEBHOOK_ID = "d6c04913-2e31-4a0e-ac01-f8a5341fa133";
Â  Â  const SAVED_DATA_WEBHOOK_ID = "f1a1833b-d2c0-4d22-b034-77090fdd24f4"; 
Â  Â  const CONTACT_OUTPUT_PATH = "data.resultData.runData[\"Contact Lookup AI\"][0].data.main[0][0].json.message.content";
Â  Â Â 
Â  Â  let executionId = null;
Â  Â  let executionResumeUrl = null;
Â  Â  let currentContactInfo = null;

Â  Â  /* --- Utility Functions --- */
Â  Â  function showStatus(message, type = 'info') {Â 
Â  Â  Â  Â  const statusDiv = document.getElementById('status') || document.createElement('div');
Â  Â  Â  Â  if (!document.getElementById('status')) {
Â  Â  Â  Â  Â  Â  statusDiv.id = 'status';
Â  Â  Â  Â  Â  Â  statusDiv.classList.add('status-message');
Â  Â  Â  Â  Â  Â  document.getElementById('lookupInput').appendChild(statusDiv);
Â  Â  Â  Â  }
Â  Â  Â  Â  statusDiv.className = `status-message status-${type}`;
Â  Â  Â  Â  statusDiv.innerHTML = message;
Â  Â  }
Â  Â  function showLoading(element, text = 'Processing...') {Â 
Â  Â  Â  Â  element.innerHTML = `<span class="loading"></span>${text}`;
Â  Â  Â  Â  element.disabled = true;
Â  Â  Â  Â  element.classList.add('disabled-button');
Â  Â  }
Â  Â  function hideLoading(element, originalText) {
Â  Â  Â  Â  element.innerHTML = originalText;
Â  Â  Â  Â  element.disabled = false;
Â  Â  Â  Â  element.classList.remove('disabled-button');
Â  Â  }
Â  Â  function formatText(text) {Â 
Â  Â  Â  Â  return (text || '')
Â  Â  Â  Â  Â  Â  .replace(/\\n/g, '<br>')
Â  Â  Â  Â  Â  Â  .replace(/\\r/g, '')
Â  Â  Â  Â  Â  Â  .replace(/\\t/g, '&nbsp;&nbsp;&nbsp;&nbsp;')
Â  Â  Â  Â  Â  Â  .replace(/\\"/g, '"')
Â  Â  Â  Â  Â  Â  .replace(/\\'/g, "'")
Â  Â  Â  Â  Â  Â  .replace(/\\\\/g, '\\')
Â  Â  Â  Â  Â  Â  .trim();
Â  Â  }
Â  Â Â 
Â  Â  /* ------------------------------------------------------------------- */
Â  Â Â 
Â  Â  // Stage 1: Initial Prompt Submission (START WORKFLOW)
Â  Â  async function submitContactPrompt() {
Â  Â  Â  Â  const promptElement = document.getElementById("lookup_prompt");
Â  Â  Â  Â  const lookupPrompt = promptElement.value.trim();
Â  Â  Â  Â  const submitBtn = document.getElementById('submitBtn');
Â  Â  Â  Â  const originalText = submitBtn.innerHTML;

Â  Â  Â  Â  if (!lookupPrompt) {
Â  Â  Â  Â  Â  Â  showStatus('Please enter a request for contact information!', 'error');
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  submitBtn.disabled = true;
Â  Â  Â  Â  promptElement.disabled = true;
Â  Â  Â  Â  showLoading(submitBtn, 'Searching AI...');
Â  Â  Â  Â  document.getElementById('contact_content').innerHTML = '<div class="waiting-animation"></div>';
Â  Â  Â  Â  showStatus('Starting contact lookup workflow...', 'info');

Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  // 1. Trigger N8N workflow via semkhor json-proxy
Â  Â  Â  Â  Â  Â  const response = await fetch(API_URL+'util/json-proxy', {
Â  Â  Â  Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  Â  Â  Â  headers: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'Content-Type': 'application/json',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'SEMKHOR-CLIENT-CODE': API_CLIENT_CODE
Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  url: `${N8N_BASE_URL}/webhook/${CONTACT_WEBHOOK_ID}`,Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  headers: [{"name": "token", "value": "{auth:n8n_header}"}],Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  data: {"prompt": lookupPrompt}
Â  Â  Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
Â  Â  Â  Â  Â  Â  const data = await response.json();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  executionId = data.response.return.executionId;Â 
Â  Â  Â  Â  Â  Â  executionResumeUrl = data.response.return.executionResumeUrl;Â 

Â  Â  Â  Â  Â  Â  if (!executionId || !executionResumeUrl) {
Â  Â  Â  Â  Â  Â  Â  Â  throw new Error('Missing execution data from workflow response');
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  showStatus('AI is looking up contact details...', 'info');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  await workflowWait(submitBtn, originalText);

Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  console.error('Error submitting prompt:', error);
Â  Â  Â  Â  Â  Â  showStatus(`Error: ${error.message}`, 'error');
Â  Â  Â  Â  Â  Â  submitBtn.disabled = false;
Â  Â  Â  Â  Â  Â  promptElement.disabled = false;
Â  Â  Â  Â  Â  Â  document.getElementById('contact_content').innerHTML = '';
Â  Â  Â  Â  Â  Â  hideLoading(submitBtn, originalText);
Â  Â  Â  Â  }
Â  Â  }

Â  Â  // Stage 2: Polling for AI result (PAUSE/POLL)
Â  Â  async function workflowWait(submitBtn, originalText) {
Â  Â  Â  Â  const maxCycles = 5;Â 
Â  Â  Â  Â  let currentCycle = 1;

Â  Â  Â  Â  const pollCycle = async () => {
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  showStatus(`Polling for AI result... (cycle ${currentCycle}/${maxCycles})`, 'info');
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const response = await fetch(API_URL+'ai/n8n-poll', {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  headers: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'Content-Type': 'application/json',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'SEMKHOR-CLIENT-CODE': API_CLIENT_CODE
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  url: `${N8N_BASE_URL}/api/v1/executions/${executionId}`,Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  headers: [{"name": "X-N8N-API-KEY", "value": "{auth:n8n_api_key}"}],Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  output_paths: [CONTACT_OUTPUT_PATH]Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
Â  Â  Â  Â  Â  Â  Â  Â  const data = await response.json();
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (data.response.status === 'waiting' && data.response.value1) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentContactInfo = data.response.value1;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  hideLoading(submitBtn, originalText);Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  reviewContactInfo(currentContactInfo);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return; // Stop polling
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  if (data.response.status === 'timeout' && currentCycle < maxCycles) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentCycle++;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showStatus(`AI is taking longer than usual... trying again (cycle ${currentCycle}/${maxCycles})`, 'info');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(pollCycle, 4000);Â 
Â  Â  Â  Â  Â  Â  Â  Â  } else if (data.response.status === 'timeout') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw new Error('Maximum wait time exceeded. The workflow might have stalled or timed out completely.');
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw new Error(`Unexpected response status: ${data.response.status}`);
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Error polling workflow:', error);
Â  Â  Â  Â  Â  Â  Â  Â  showStatus(`Error waiting for result: ${error.message}`, 'error');
Â  Â  Â  Â  Â  Â  Â  Â  hideLoading(submitBtn, originalText);
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById("lookup_prompt").disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('contact_content').innerHTML = '';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };

Â  Â  Â  Â  pollCycle();
Â  Â  }

Â  Â  // Stage 3: Display results and ask for save decision
Â  Â  function reviewContactInfo(info) {
Â  Â  Â  Â  showStatus('Contact information found!', 'success');
Â  Â  Â  Â Â 
Â  Â  Â  Â  const formattedInfo = formatText(info);
Â  Â  Â  Â  document.getElementById('contact_content').innerHTML = `**Request:** ${document.getElementById("lookup_prompt").value}<br><br>**AI Result:**<br>${formattedInfo}`;
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Switch UI panels
Â  Â  Â  Â  document.getElementById('lookupInput').style.display = 'none';
Â  Â  Â  Â  document.getElementById('reviewSection').style.display = 'block';
Â  Â  Â  Â Â 
Â  Â  Â  Â  document.getElementById('reviewSection').scrollIntoView({ behavior: 'smooth' });
Â  Â  }

Â  Â  // Stage 4: Resume workflow with user decision (SAVE/REJECT)
Â  Â  async function respondToSave(saveData) {
Â  Â  Â  Â  // MODIFIED: Simplified payload to only send the boolean required by the If node.
Â  Â  Â  Â  const payload = {
Â  Â  Â  Â  Â  Â  saveToSheets: saveDataÂ 
Â  Â  Â  Â  };

Â  Â  Â  Â  const saveBtn = document.getElementById('saveBtn');
Â  Â  Â  Â  const rejectBtn = document.getElementById('rejectBtn');
Â  Â  Â  Â  const activeBtn = saveData ? saveBtn : rejectBtn;
Â  Â  Â  Â  const originalText = activeBtn.innerHTML;
Â  Â  Â  Â Â 
Â  Â  Â  Â  showLoading(activeBtn, saveData ? 'Saving to Sheets...' : 'Canceling Save...');
Â  Â  Â  Â  saveBtn.disabled = true;
Â  Â  Â  Â  rejectBtn.disabled = true;
Â  Â  Â  Â  saveBtn.classList.add('disabled-button');
Â  Â  Â  Â  rejectBtn.classList.add('disabled-button');

Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  // Post the payload to the n8n Wait node resume URL
Â  Â  Â  Â  Â  Â  const response = await fetch(API_URL+'util/json-proxy', {
Â  Â  Â  Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  Â  Â  Â  headers: { 'Content-Type': 'application/json', 'SEMKHOR-CLIENT-CODE': API_CLIENT_CODE },
Â  Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  url: executionResumeUrl,Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  headers: [{"name": "token", "value": "{auth:n8n_header}"}],
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  data: payloadÂ 
Â  Â  Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

Â  Â  Â  Â  Â  Â  hideLoading(activeBtn, originalText);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const completionMsg = saveData ?	
Â  Â  Â  Â  Â  Â  Â  Â  'âœ… Success! Contact details have been saved to Google Sheets. ðŸ’¾' :	
Â  Â  Â  Â  Â  Â  Â  Â  'âŒ Decision finalized. Data was NOT saved to Google Sheets. ðŸ‘';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const completionDiv = document.createElement('div');
Â  Â  Â  Â  Â  Â  completionDiv.className = 'completion-message';
Â  Â  Â  Â  Â  Â  completionDiv.innerHTML = completionMsg;
Â  Â  Â  Â  Â  Â  document.getElementById('reviewSection').appendChild(completionDiv);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  showStatus('Workflow completed successfully!', 'success');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Show a reset button and the "View Saved Data" button
Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  const resetBtn = document.createElement('button');
Â  Â  Â  Â  Â  Â  Â  Â  resetBtn.innerHTML = 'ðŸ”„ Start New Lookup';
Â  Â  Â  Â  Â  Â  Â  Â  resetBtn.onclick = resetForm;
Â  Â  Â  Â  Â  Â  Â  Â  resetBtn.style.marginTop = '20px';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('reviewSection').appendChild(resetBtn);

Â  Â  Â  Â  Â  Â  Â  Â  const viewBtn = document.createElement('button');
Â  Â  Â  Â  Â  Â  Â  Â  viewBtn.innerHTML = 'ðŸ“‚ View Saved Data';
Â  Â  Â  Â  Â  Â  Â  Â  viewBtn.onclick = viewSavedData;
Â  Â  Â  Â  Â  Â  Â  Â  viewBtn.classList.add('button_view');
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('reviewSection').appendChild(viewBtn);

Â  Â  Â  Â  Â  Â  }, 1500);

Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  console.error('Error responding:', error);
Â  Â  Â  Â  Â  Â  showStatus(`Error resuming workflow: ${error.message}`, 'error');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Re-enable buttons on error
Â  Â  Â  Â  Â  Â  saveBtn.disabled = false;
Â  Â  Â  Â  Â  Â  rejectBtn.disabled = false;
Â  Â  Â  Â  Â  Â  saveBtn.classList.remove('disabled-button');
Â  Â  Â  Â  Â  Â  rejectBtn.classList.remove('disabled-button');
Â  Â  Â  Â  Â  Â  hideLoading(activeBtn, originalText);
Â  Â  Â  Â  }
Â  Â  }

Â  Â  // Feature: Display previously saved data (Simplified: Direct Link to Sheet)
Â  Â  async function viewSavedData() {
Â  Â  Â  Â  const SHEET_URL = "https://docs.google.com/spreadsheets/d/15E13ShiEYhbN4FlwFplmK38rw4lZGQCll_U99CdqBuQ/edit?gid=0#gid=0";
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Open the Google Sheet URL in a new browser tab/window
Â  Â  Â  Â  window.open(SHEET_URL, '_blank');
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Optionally, display a success message temporarily on the UI
Â  Â  Â  Â  const statusDiv = document.getElementById('status') || document.createElement('div');
Â  Â  Â  Â  if (!document.getElementById('status')) {
Â  Â  Â  Â  Â  Â  statusDiv.id = 'status';
Â  Â  Â  Â  Â  Â  statusDiv.classList.add('status-message');
Â  Â  Â  Â  Â  Â  document.getElementById('lookupInput').appendChild(statusDiv);
Â  Â  Â  Â  }
Â  Â  Â  Â  statusDiv.className = `status-message status-success`;
Â  Â  Â  Â  statusDiv.innerHTML = 'ðŸ“‚ Opening Google Sheet in a new tab!';

Â  Â  Â  Â  // Hide the table panel if it was already showing
Â  Â  Â  Â  document.getElementById('savedDataSection').style.display = 'none';
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Clear the message after a few seconds
Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  if (statusDiv) { statusDiv.remove(); }
Â  Â  Â  Â  }, 3000);
Â  Â  }

Â  Â  function resetForm() {
Â  Â  Â  Â  // Clear all state and display the initial input panel
Â  Â  Â  Â  document.getElementById('lookupInput').style.display = 'block';
Â  Â  Â  Â  document.getElementById('reviewSection').style.display = 'none';
Â  Â  Â  Â  document.getElementById('savedDataSection').style.display = 'none';
Â  Â  Â  Â  document.getElementById('lookup_prompt').value = '';
Â  Â  Â  Â  document.getElementById('contact_content').innerHTML = '';
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Re-enable input controls and restore original button text
Â  Â  Â  Â  document.getElementById('lookup_prompt').disabled = false;
Â  Â  Â  Â  const submitBtn = document.getElementById('submitBtn');
Â  Â  Â  Â  submitBtn.disabled = false;
Â  Â  Â  Â  submitBtn.innerHTML = 'Look Up Contact!';
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Reset review buttons
Â  Â  Â  Â  const saveBtn = document.getElementById('saveBtn');
Â  Â  Â  Â  const rejectBtn = document.getElementById('rejectBtn');
Â  Â  Â  Â  saveBtn.disabled = false;
Â  Â  Â  Â  rejectBtn.disabled = false;
Â  Â  Â  Â  saveBtn.classList.remove('disabled-button');
Â  Â  Â  Â  rejectBtn.classList.remove('disabled-button');
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Clear status and completion messages
Â  Â  Â  Â  const statusDiv = document.getElementById('status');
Â  Â  Â  Â  if (statusDiv) { statusDiv.remove(); }
Â  Â  Â  Â  const completionDiv = document.querySelector('.completion-message');
Â  Â  Â  Â  if (completionDiv) { completionDiv.remove(); }
Â  Â  Â  Â  const reviewBtns = document.querySelectorAll('#reviewSection button');
Â  Â  Â  Â  reviewBtns.forEach(btn => {
Â  Â  Â  Â  Â  Â  if (btn.innerHTML.includes('Start New Lookup') || btn.innerHTML.includes('View Saved Data')) {
Â  Â  Â  Â  Â  Â  Â  Â  btn.remove();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Reset global variables
Â  Â  Â  Â  executionId = null;
Â  Â  Â  Â  executionResumeUrl = null;
Â  Â  Â  Â  currentContactInfo = null;
Â  Â  Â  Â Â 
Â  Â  Â  Â  document.getElementById('lookupInput').scrollIntoView({ behavior: 'smooth' });
Â  Â  }
</script>
</head>
<body>

	<div class="header">
		<img src="ai-joke/images/semkhor_transparent.png" alt="SEMKHOR Logo">
	</div>

	<div class="panel" id="lookupInput">
		Find contact information for...
		<input type="text" id="lookup_prompt" placeholder="e.g., procurement manager of Bokku! Mart in East Lagos"><br>
		<button id="submitBtn" onclick="submitContactPrompt()">Look Up Contact!</button>
	</div>
	
	<div class="panel" id="reviewSection" style="display: none;">
		<h3 style="margin-bottom: 10px;">Review AI-Generated Contact Information</h3>
		<div id="contact_content"></div>
		<button id="saveBtn" class="button_save" onclick="respondToSave(true)">Save to Google Sheets</button>
		<button id="rejectBtn" class="button_reject" onclick="respondToSave(false)">Reject, Do Not Save</button>
	</div>

Â  Â  <div class="panel" id="savedDataSection" style="display: none;">
		<h3 style="margin-bottom: 10px; color: #5a67d8;">Previously Saved Contact Leads</h3>
		<div id="savedDataTableContainer">
			</div>
Â  Â  Â  Â  <button onclick="document.getElementById('savedDataSection').style.display='none'; document.getElementById('reviewSection').scrollIntoView({ behavior: 'smooth' });">Hide Table</button>
	</div>


</body>
</html>
