<script>
    /* --- API Configuration (from original joke flow) --- */
    // Accessing the SEMKHOR API requires knowing the API_URL and API_CLIENT_CODE.
    // ** NOTE: The provided code forced these values, keeping them for consistency. **
    const API_CLIENT_CODE = "semkhorproductions1"; 
    const API_URL = "https://www.semkhor.com/api/"; 
    
    // ** NOTE: This must match your n8n workspace URL **
    const N8N_BASE_URL = "https://alexsemkhor.app.n8n.cloud"; 
    
    // ** FINALIZED CONFIGURATION (READ DATA) **
    // 1. TRIGGER WORKFLOW WEBHOOK PATH (from first workflow JSON)
    const CONTACT_WEBHOOK_ID = "d6c04913-2e31-4a0e-ac01-f8a5341fa133"; // MODIFIED - Used the path, not the ID
    // 2. SAVED DATA WEBHOOK PATH (from second workflow JSON)
    const SAVED_DATA_WEBHOOK_ID = "f1a1833b-d2c0-4d22-b034-77090fdd24f4"; // MODIFIED - Used the path from the "Webhook" node
    // 3. AI OUTPUT PATH (from the name of the AI node)
    const CONTACT_OUTPUT_PATH = "data.resultData.runData[\"Contact Lookup AI\"][0].data.main[0][0].json.message.content";
    
    // Global variables to store execution data
    let executionId = null;
    let executionResumeUrl = null;
    let currentContactInfo = null;

    /* --- Utility Functions (Adapted from Joke Flow) --- */
    function showStatus(message, type = 'info') { 
        const statusDiv = document.getElementById('status') || document.createElement('div');
        if (!document.getElementById('status')) {
            statusDiv.id = 'status';
            statusDiv.classList.add('status-message');
            document.getElementById('lookupInput').appendChild(statusDiv);
        }
        statusDiv.className = `status-message status-${type}`;
        statusDiv.innerHTML = message;
    }
    function showLoading(element, text = 'Processing...') { 
        element.innerHTML = `<span class="loading"></span>${text}`;
        element.disabled = true;
        element.classList.add('disabled-button');
    }
    function hideLoading(element, originalText) {
        element.innerHTML = originalText;
        element.disabled = false;
        element.classList.remove('disabled-button');
    }
    function formatText(text) { 
        // Simple text formatting, similar to the joke flow
        return (text || '')
            .replace(/\\n/g, '<br>')
            .replace(/\\r/g, '')
            .replace(/\\t/g, '&nbsp;&nbsp;&nbsp;&nbsp;')
            .replace(/\\"/g, '"')
            .replace(/\\'/g, "'")
            .replace(/\\\\/g, '\\')
            .trim();
    }
    
    /* ------------------------------------------------------------------- */
    
    // Stage 1: Initial Prompt Submission (START WORKFLOW)
    async function submitContactPrompt() {
        const promptElement = document.getElementById("lookup_prompt");
        const lookupPrompt = promptElement.value.trim();
        const submitBtn = document.getElementById('submitBtn');
        const originalText = submitBtn.innerHTML;

        if (!lookupPrompt) {
            showStatus('Please enter a request for contact information!', 'error');
            return;
        }

        submitBtn.disabled = true;
        promptElement.disabled = true;
        showLoading(submitBtn, 'Searching AI...');
        document.getElementById('contact_content').innerHTML = '<div class="waiting-animation"></div>';
        showStatus('Starting contact lookup workflow...', 'info');

        try {
            // 1. Trigger N8N workflow via semkhor json-proxy
            const response = await fetch(API_URL+'util/json-proxy', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'SEMKHOR-CLIENT-CODE': API_CLIENT_CODE
                },
                body: JSON.stringify({
                    url: `${N8N_BASE_URL}/webhook/${CONTACT_WEBHOOK_ID}`, 
                    method: 'POST',
                    headers: [{"name": "token", "value": "{auth:n8n_header}"}], 
                    data: {"prompt": lookupPrompt}
                })
            });

            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const data = await response.json();
            
            // 2. Extract execution details from N8N's immediate response
            // MODIFIED: Correct path is data.response.return.executionId/executionResumeUrl 
            // based on the "Respond to Webhook" node's response body. 
            executionId = data.response.return.executionId; // MODIFIED
            executionResumeUrl = data.response.return.executionResumeUrl; // MODIFIED

            if (!executionId || !executionResumeUrl) {
                throw new Error('Missing execution data from workflow response');
            }

            showStatus('AI is looking up contact details...', 'info');
            
            // 3. Start polling
            await workflowWait(submitBtn, originalText);

        } catch (error) {
            console.error('Error submitting prompt:', error);
            showStatus(`Error: ${error.message}`, 'error');
            // Re-enable controls on error
            submitBtn.disabled = false;
            promptElement.disabled = false;
            document.getElementById('contact_content').innerHTML = '';
            hideLoading(submitBtn, originalText);
        }
    }

    // Stage 2: Polling for AI result (PAUSE/POLL)
    async function workflowWait(submitBtn, originalText) {
        const maxCycles = 5; 
        let currentCycle = 1;

        const pollCycle = async () => {
            try {
                showStatus(`Polling for AI result... (cycle ${currentCycle}/${maxCycles})`, 'info');
                
                // Poll the n8n execution status (via semkhor ai/n8n-poll)
                const response = await fetch(API_URL+'ai/n8n-poll', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'SEMKHOR-CLIENT-CODE': API_CLIENT_CODE
                    },
                    body: JSON.stringify({
                        // URL is constructed as https://{workspaceName}.app.n8n.cloud/api/v1/execution/{executionId} [cite: 66]
                        url: `${N8N_BASE_URL}/api/v1/executions/${executionId}`, 
                        // Header is [{"name":"X-N8N-API-KEY", "value":"{auth:n8n_api_key}"}] [cite: 67]
                        headers: [{"name": "X-N8N-API-KEY", "value": "{auth:n8n_api_key}"}], 
                        output_paths: [CONTACT_OUTPUT_PATH] 
                    })
                });

                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                
                // Check if status is "waiting" and data is present (signalling the Wait node) [cite: 63]
                if (data.response.status === 'waiting' && data.response.value1) {
                    currentContactInfo = data.response.value1;
                    hideLoading(submitBtn, originalText); 
                    reviewContactInfo(currentContactInfo);
                    return; // Stop polling
                }

                // Check if the endpoint timed out
                if (data.response.status === 'timeout' && currentCycle < maxCycles) {
                    currentCycle++;
                    showStatus(`AI is taking longer than usual... trying again (cycle ${currentCycle}/${maxCycles})`, 'info');
                    setTimeout(pollCycle, 4000); 
                } else if (data.response.status === 'timeout') {
                    throw new Error('Maximum wait time exceeded. The workflow might have stalled or timed out completely.');
                } else {
                    throw new Error(`Unexpected response status: ${data.response.status}`);
                }

            } catch (error) {
                console.error('Error polling workflow:', error);
                showStatus(`Error waiting for result: ${error.message}`, 'error');
                hideLoading(submitBtn, originalText);
                document.getElementById("lookup_prompt").disabled = false;
                document.getElementById('contact_content').innerHTML = '';
            }
        };

        pollCycle();
    }

    // Stage 3: Display results and ask for save decision
    function reviewContactInfo(info) {
        showStatus('Contact information found!', 'success');
        
        const formattedInfo = formatText(info);
        document.getElementById('contact_content').innerHTML = `**Request:** ${document.getElementById("lookup_prompt").value}<br><br>**AI Result:**<br>${formattedInfo}`;
        
        // Switch UI panels
        document.getElementById('lookupInput').style.display = 'none';
        document.getElementById('reviewSection').style.display = 'block';
        
        document.getElementById('reviewSection').scrollIntoView({ behavior: 'smooth' });
    }

    // Stage 4: Resume workflow with user decision (SAVE/REJECT)
    async function respondToSave(saveData) {
        // The payload only needs saveToSheets, as the Google Sheets node pulls 
        // the other data (prompt, AI output) directly from the previous nodes.
        const payload = {
            saveToSheets: saveData, // MODIFIED - Simplified payload based on n8n If node logic
        };

        const saveBtn = document.getElementById('saveBtn');
        const rejectBtn = document.getElementById('rejectBtn');
        const activeBtn = saveData ? saveBtn : rejectBtn;
        const originalText = activeBtn.innerHTML;
        
        showLoading(activeBtn, saveData ? 'Saving to Sheets...' : 'Canceling Save...');
        saveBtn.disabled = true;
        rejectBtn.disabled = true;
        saveBtn.classList.add('disabled-button');
        rejectBtn.classList.add('disabled-button');

        try {
            // Post the payload to the n8n Wait node resume URL [cite: 82, 83]
            const response = await fetch(API_URL+'util/json-proxy', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'SEMKHOR-CLIENT-CODE': API_CLIENT_CODE }, // MODIFIED - Added client code
                body: JSON.stringify({
                    url: executionResumeUrl, 
                    method: 'POST',
                    headers: [{"name": "token", "value": "{auth:n8n_header}"}], // Headers for the Wait node resume webhook [cite: 84]
                    data: payload 
                })
            });

            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

            hideLoading(activeBtn, originalText);
            
            const completionMsg = saveData ?	
                'âœ… Success! Contact details have been saved to Google Sheets. ðŸ’¾' :	
                'âŒ Decision finalized. Data was NOT saved to Google Sheets. ðŸ‘';
            
            const completionDiv = document.createElement('div');
            completionDiv.className = 'completion-message';
            completionDiv.innerHTML = completionMsg;
            document.getElementById('reviewSection').appendChild(completionDiv);
            
            showStatus('Workflow completed successfully!', 'success');
            
            // Show a reset button and the "View Saved Data" button
            setTimeout(() => {
                const resetBtn = document.createElement('button');
                resetBtn.innerHTML = 'ðŸ”„ Start New Lookup';
                resetBtn.onclick = resetForm;
                resetBtn.style.marginTop = '20px';
                document.getElementById('reviewSection').appendChild(resetBtn);

                const viewBtn = document.createElement('button');
                viewBtn.innerHTML = 'ðŸ“‚ View Saved Data';
                viewBtn.onclick = viewSavedData;
                viewBtn.classList.add('button_view');
                document.getElementById('reviewSection').appendChild(viewBtn);

            }, 1500);

        } catch (error) {
            console.error('Error responding:', error);
            showStatus(`Error resuming workflow: ${error.message}`, 'error');
            
            // Re-enable buttons on error
            saveBtn.disabled = false;
            rejectBtn.disabled = false;
            saveBtn.classList.remove('disabled-button');
            rejectBtn.classList.remove('disabled-button');
            hideLoading(activeBtn, originalText);
        }
    }

    // Feature: Display previously saved data
    async function viewSavedData() {
        const viewPanel = document.getElementById('savedDataSection');
        const resultDiv = document.getElementById('savedDataTableContainer');
        viewPanel.style.display = 'block';
        resultDiv.innerHTML = '<div class="waiting-animation">Fetching saved data...</div>';

        try {
            // Placeholder URL for an N8N workflow that reads all data from your Google Sheet.
            const SAVED_DATA_WEBHOOK_URL = `${N8N_BASE_URL}/webhook/${SAVED_DATA_WEBHOOK_ID}`; // MODIFIED: Use new constant

            const fetchSavedData = await fetch(API_URL+'util/json-proxy', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'SEMKHOR-CLIENT-CODE': API_CLIENT_CODE
                },
                body: JSON.stringify({
                    url: SAVED_DATA_WEBHOOK_URL,
                    method: 'POST',
                    headers: [{"name": "token", "value": "{auth:n8n_header}"}],
                    data: {"action": "get_all"} 
                })
            });

            if (!fetchSavedData.ok) throw new Error(`HTTP error! status: ${fetchSavedData.status}`);
            const data = await fetchSavedData.json();

            // The second workflow uses a simple "Respond to Webhook" node *after* the Google Sheets node, 
            // but it's configured to return only execution IDs.
            // MODIFIED: Since the n8n JSON doesn't show the data being returned, we must rely on the
            // assumption that the Google Sheets output is passed to the response. We will structure the table
            // based on the column names used for saving in the first workflow (Business, Contact Info, Timestamp).
            // A well-formed 'get' webhook should return the data under 'data.response.return'.
            const savedContacts = data.response.return || []; 
            
            if (savedContacts.length === 0) {
                resultDiv.innerHTML = '<p style="font-weight: normal; color: #cc5555;">No saved data found in the spreadsheet via the API. Ensure the "GET ALL" webhook is configured.</p>';
                return;
            }

            let tableHTML = '<table id="savedDataTable"><thead><tr><th>Request (Business)</th><th>Contact Info Snippet</th><th>Saved At (Timestamp)</th></tr></thead><tbody>';
            
            savedContacts.forEach(row => {
                // MODIFIED: Use the column names from the Google Sheets Append node in the first workflow.
                const request = row.Business || 'N/A'; // Column 1
                const contactInfo = row['Contact Info'] || ''; // Column 2
                const timestamp = row.Timestamp || new Date().toISOString(); // Column 3

                const snippet = contactInfo.substring(0, 70) + (contactInfo.length > 70 ? '...' : '');
                const date = new Date(timestamp).toLocaleDateString();

                tableHTML += `
                    <tr>
                        <td>${request}</td>
                        <td>${snippet}</td>
                        <td>${date}</td>
                    </tr>
                `;
            });

            tableHTML += '</tbody></table>';
            resultDiv.innerHTML = tableHTML;
            document.getElementById('savedDataSection').scrollIntoView({ behavior: 'smooth' });


        } catch (error) {
            console.error('Error fetching saved data:', error);
            resultDiv.innerHTML = `<p style="font-weight: normal; color: #cc5555;">Failed to load saved data: ${error.message}. Ensure the 'GET ALL' n8n workflow is active.</p>`;
        }
    }

    function resetForm() {
        // ... (rest of the resetForm function remains unchanged)
        document.getElementById('lookupInput').style.display = 'block';
        document.getElementById('reviewSection').style.display = 'none';
        document.getElementById('savedDataSection').style.display = 'none';
        document.getElementById('lookup_prompt').value = '';
        document.getElementById('contact_content').innerHTML = '';
        
        // Re-enable input controls and restore original button text
        document.getElementById('lookup_prompt').disabled = false;
        const submitBtn = document.getElementById('submitBtn');
        submitBtn.disabled = false;
        submitBtn.innerHTML = 'Look Up Contact!';
        
        // Reset review buttons
        const saveBtn = document.getElementById('saveBtn');
        const rejectBtn = document.getElementById('rejectBtn');
        saveBtn.disabled = false;
        rejectBtn.disabled = false;
        saveBtn.classList.remove('disabled-button');
        rejectBtn.classList.remove('disabled-button');
        
        // Clear status and completion messages
        const statusDiv = document.getElementById('status');
        if (statusDiv) { statusDiv.remove(); }
        const completionDiv = document.querySelector('.completion-message');
        if (completionDiv) { completionDiv.remove(); }
        const reviewBtns = document.querySelectorAll('#reviewSection button');
        reviewBtns.forEach(btn => {
            if (btn.innerHTML.includes('Start New Lookup') || btn.innerHTML.includes('View Saved Data')) {
                btn.remove();
            }
        });
        
        // Reset global variables
        executionId = null;
        executionResumeUrl = null;
        currentContactInfo = null;
        
        document.getElementById('lookupInput').scrollIntoView({ behavior: 'smooth' });
    }
</script>
